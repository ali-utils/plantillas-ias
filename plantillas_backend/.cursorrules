# Cursor AI Rules - bMOI Backend API Multi-Tenant

## Proyecto
- Nombre: bMOI Backend API Multi-Tenant
- Framework: NestJS 10 + TypeScript 5
- Database: PostgreSQL 15 con Row-Level Security
- Cache: Redis 7
- ORM: Prisma
- Entorno: Docker (OBLIGATORIO)

## ğŸ³ Desarrollo con Docker

âš ï¸ TODO el desarrollo se hace en Docker:

```bash
# âœ… SIEMPRE
docker compose up -d
docker compose exec backend npm install [package]
docker compose exec backend npx prisma migrate dev

# âŒ NUNCA
npm install
npm run start:dev
```

## Convenciones OBLIGATORIAS

### Nomenclatura
- Archivos: kebab-case (users.controller.ts, create-user.dto.ts)
- Clases: PascalCase (UsersController, CreateUserDto)
- MÃ©todos y variables: camelCase (findAll, currentTenant)
- Constantes: UPPER_SNAKE_CASE (JWT_SECRET, DATABASE_URL)
- Enums: PascalCase (UserRole, PlanType)
- âŒ PROHIBIDO: snake_case en TypeScript

### Multi-Tenant (CRÃTICO)
- SIEMPRE usar @UseGuards(JwtAuthGuard, TenantGuard)
- SIEMPRE @UseInterceptors(TenantInterceptor)
- SIEMPRE set PostgreSQL session para RLS:
  ```typescript
  await this.prisma.$executeRaw`
    SELECT set_config('app.current_tenant_id', ${tenantId}, true)
  `
  ```
- SIEMPRE incluir tenant_id en inserts
- NUNCA queries sin tenant context

### TypeScript
- NO usar `any` type (usar unknown o tipos especÃ­ficos)
- Todos los DTOs con class-validator
- Todos los endpoints con Swagger decorators

### Seguridad
- JWT con RS256 (asymmetric)
- Passwords con bcrypt (10 rounds)
- NUNCA retornar passwords en responses
- Validar permisos con @RequirePermission()
- Validar lÃ­mites con @CheckPlanLimit()

## Estructura de MÃ³dulos

```
src/modules/resource/
â”œâ”€â”€ resource.module.ts
â”œâ”€â”€ resource.controller.ts
â”œâ”€â”€ resource.service.ts
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ create-resource.dto.ts
â”‚   â””â”€â”€ update-resource.dto.ts
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ resource.entity.ts
â””â”€â”€ tests/
    â”œâ”€â”€ resource.controller.spec.ts
    â””â”€â”€ resource.service.spec.ts
```

## Testing
- Coverage mÃ­nimo: 80%
- Unit tests para services
- E2E tests para endpoints crÃ­ticos
- Mock PrismaService en tests

## Logging
- Usar Logger de NestJS (NO console.log)
- Logger por clase: `private readonly logger = new Logger(ClassName.name)`

## Documentos CrÃ­ticos
Leer antes de programar:
- PROJECT_INSTRUCTIONS.md
- CODING_STANDARDS.md
- BACKEND_ARCHITECTURE.md
- .claude/context.md
- .claude/conventions.md

## Prohibiciones
- âŒ snake_case en TypeScript
- âŒ any type
- âŒ console.log en producciÃ³n
- âŒ Queries sin tenant_id
- âŒ Passwords en responses
- âŒ Controllers > 300 lÃ­neas
- âŒ Hardcodear secrets
